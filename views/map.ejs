<%- include header %>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script type="text/javascript" src="http://yourjavascript.com/9435251235/togeojson.js"></script>
<script type="text/javascript" src="http://yourjavascript.com/5525392134/maps-google-polygon-containslatlng.js"></script>

<script>
    console.log('inside script tag');
    var map;
    var markers = [];
    var windows = [];
    var boundaryJSON;
    var region = [], opened_info;
    function initialize() {
        console.log('in initialize.');

        var mapOptions = {
            zoom: 12,
            center: new google.maps.LatLng(49.246292, -123.116226)
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
                mapOptions);


        <%for(var i in crimes) {%>
            var contentString<%=i%> = 'Address: <%=crimes[i].address%> ';
            var window<%=i%> = new google.maps.InfoWindow({
                content:contentString<%=i%>
            });
            windows = window<%=i%>;
            var latLng = new google.maps.LatLng(<%=crimes[i].lat%>, <%=crimes[i].long%>);
            var marker<%=i%> = new google.maps.Marker({
                position: latLng,
                title: "<%=crimes[i].address%>"
            });


            markers.push(marker<%=i%>);

            google.maps.event.addListener(marker<%=i%>, 'click', function() {
                window<%=i%>.open(map,marker<%=i%>);


                setTimeout(function () {
                    window<%=i%>.close();
                }, 2000);
            });

        google.maps.event.addListener(map, "click", function (event) {
            window<%=i%>.close();
        });

        <%}%>


        $.ajax('./map/boundary').done(function (xml) {

            boundaryJSON = toGeoJSON.kml(xml);

            console.log(boundaryJSON);

            for (j = 0; j < boundaryJSON.features.length; j++) {
                var polygonPaths = [];
                for (index = 0; index < boundaryJSON.features[j].geometry.coordinates[0].length; index++) {

                    var latlng = boundaryJSON.features[j].geometry.coordinates[0][index];

                    var lat = latlng[1];

                    var lng = latlng[0];

                    polygonPaths[index] = new google.maps.LatLng(lat, lng);
                }

                var currentRegionName = boundaryJSON.features[j].properties.name;
                region[j] = new google.maps.Polygon({
                    paths: polygonPaths,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.05,
                    title: currentRegionName
                });


                region[j].infowindow = new google.maps.InfoWindow({
                    content: 'Region: ' + currentRegionName
                });
                region[j].setMap(map);


                google.maps.event.addListener(region[j], 'mouseover', function(event) {

                    for( i =0; i< region.length;i++) {
                        var isWithin = region[i].containsLatLng(event.latLng.k, event.latLng.D);
                        if( isWithin)
                        {
                            document.getElementById('info-box').textContent =
                                    'Region:'+boundaryJSON.features[i].properties.name;
                            break;
                        }
                    }


                });

                google.maps.event.addListener(region[j], 'click', function (event) {
                    for( i =0; i< region.length;i++) {
                        var isWithin = region[i].containsLatLng(event.latLng.k, event.latLng.D);
                        if( isWithin)
                        {
                            document.getElementById('comments').textContent =
                                    'Comments in Region:'+boundaryJSON.features[i].properties.name;
                            break;
                        }
                    }
                });
                google.maps.event.addListener(map, 'mouseover', function (event) {
                    document.getElementById('info-box').textContent =
                            'Region:'+ 'Not in a region of Vancouver';
                });

            }


        });
    }

    function getARegionByName(name){
        for( i =0; i< region.length;i++) {
            if(name==boundaryJSON.features[i].properties.name)
            {
                return region[i];
            }
        }
    }

    // Sets the map on all markers in the array.
    function setMarkersOnMap(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
        console.log(markers[0]);
    }

    function setRegionMarkersOnMap(map,regionName){
        for(var i = 0; i < markers.length; i++){
            var markerLat = markers[i].position.k;
            var markerLng =markers[i].position.D;

            var region = getARegionByName(regionName);

            var isWithin = region.containsLatLng(markerLat,  markerLng);
            if( isWithin)
            {
                markers[i].setMap(map);
            }
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearAllMarkers() {
        setMarkersOnMap(null);
    }

    // Shows any markers currently in the array.
    function showAllMarkers() {
        setMarkersOnMap(map);
    }

    function changeCentre(map,regionName) {
        var region = getARegionByName(regionName);
        map.setZoom(14);
        map.setCenter(region.getBounds().getCenter());

    }



    //initialize();
    console.log("in map.js");
    google.maps.event.addDomListener(window, 'load', initialize);

    function getRegions(){
        var regionList = document.getElementById("regionSelect");
        var selectedRegionName = regionList.options[regionList.selectedIndex].value;
        if(selectedRegionName!="Select Region") {
            clearAllMarkers();

            setRegionMarkersOnMap(map, selectedRegionName);
            changeCentre(map, selectedRegionName);
        }
    }



</script>



<div id="panel" >
    <input onclick="javascript:scroll(0,600)" type=button class="btnExample" value="View Comments">
    <input onclick="showAllMarkers();" type=button class="btnExample" value="Show Markers">
    <input onclick="clearAllMarkers();" type=button class="btnExample" value="Hide Markers">
</div>

<div align="center">
    <select id="regionSelect" onchange="getRegions()">
        <option>Select Region</option>
        <%
        console.log('in view: regions:', regions);
                for(var i in regions){%>
        <option value="<%=regions[i].name%>"><%=regions[i].name%></option>
        <%}%>

    </select>
</div>
<br>
<div id="info-box">Current Region</div>
<div id="map-canvas"></div>
<br>
<div id="comments"><h3>Comments:</h3><div id="back-to-top" align="right"><a href="/comment">Submit a new comment</a></div>
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam eu venenatis erat. Quisque faucibus congue vulputate. In at lorem lacus. Nulla non vestibulum urna. Fusce auctor nisl id pulvinar posuere. Curabitur vel est molestie, eleifend est sed, interdum tellus. Praesent pharetra tortor ultricies orci rutrum ultrices. Nunc porttitor dapibus ullamcorper. Cras eu tortor pulvinar, pretium est nec, faucibus felis. Morbi laoreet, lectus vel maximus euismod, nisl sem placerat neque, congue congue est urna id felis. Morbi vehicula pretium sem eu venenatis. Nullam dapibus leo turpis. Vivamus sit amet ullamcorper ex, ac ultrices arcu. Suspendisse fermentum pretium nisi sit amet fringilla.

    Mauris non sollicitudin quam. Vivamus interdum erat felis, vitae porttitor metus posuere in. Nam laoreet a urna nec suscipit. Integer a eleifend risus. Donec posuere risus at molestie suscipit. Donec varius metus nec nibh egestas, vel bibendum mi ultrices. Praesent volutpat arcu ac tristique pellentesque. Mauris eget turpis venenatis, eleifend justo sit amet, consectetur justo. Duis ut neque a velit aliquet faucibus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec sit amet feugiat lorem. In aliquam eleifend tortor, at cursus dui facilisis nec. Phasellus sed est auctor, ultrices nisl a, scelerisque enim.

    Praesent hendrerit consequat nulla, vel convallis diam ornare a. Pellentesque at mauris sit amet metus gravida dapibus. Aenean euismod magna ut lacus placerat vulputate. Aliquam auctor tincidunt elit et consequat. Vivamus tempor mauris justo, vel imperdiet ligula maximus et. Morbi a nunc vitae ligula vulputate finibus a a metus. Fusce eu tellus ligula.

    Nunc aliquam in odio sed auctor. Cras vitae justo tincidunt, vestibulum nibh quis, vestibulum nisl. Fusce tristique facilisis sapien, ut vulputate elit pharetra vitae. Ut id eros sed lectus luctus tincidunt. Nulla et dui pharetra, rutrum est vel, dapibus lorem. Donec purus mauris, condimentum at feugiat et, volutpat at nunc. Etiam ultrices odio neque, sed ullamcorper justo posuere quis. Sed auctor at ex ut commodo. Phasellus non metus fringilla, sodales tortor aliquet, condimentum sem.

    Praesent eget scelerisque tortor. Sed sed condimentum ligula. Quisque id faucibus ipsum. Phasellus neque velit, accumsan nec pulvinar eget, tincidunt sit amet eros. Duis auctor eu sapien eu laoreet. Mauris malesuada blandit mauris, quis ultrices erat facilisis et. Aliquam vel libero ultrices tortor ullamcorper molestie. In rhoncus eu eros eu dictum. Praesent ac mauris pellentesque ante eleifend ultricies id non ligula. Nullam maximus nibh sit amet aliquam euismod. Etiam faucibus ante mollis est sagittis laoreet.
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam eu venenatis erat. Quisque faucibus congue vulputate. In at lorem lacus. Nulla non vestibulum urna. Fusce auctor nisl id pulvinar posuere. Curabitur vel est molestie, eleifend est sed, interdum tellus. Praesent pharetra tortor ultricies orci rutrum ultrices. Nunc porttitor dapibus ullamcorper. Cras eu tortor pulvinar, pretium est nec, faucibus felis. Morbi laoreet, lectus vel maximus euismod, nisl sem placerat neque, congue congue est urna id felis. Morbi vehicula pretium sem eu venenatis. Nullam dapibus leo turpis. Vivamus sit amet ullamcorper ex, ac ultrices arcu. Suspendisse fermentum pretium nisi sit amet fringilla.

    Mauris non sollicitudin quam. Vivamus interdum erat felis, vitae porttitor metus posuere in. Nam laoreet a urna nec suscipit. Integer a eleifend risus. Donec posuere risus at molestie suscipit. Donec varius metus nec nibh egestas, vel bibendum mi ultrices. Praesent volutpat arcu ac tristique pellentesque. Mauris eget turpis venenatis, eleifend justo sit amet, consectetur justo. Duis ut neque a velit aliquet faucibus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec sit amet feugiat lorem. In aliquam eleifend tortor, at cursus dui facilisis nec. Phasellus sed est auctor, ultrices nisl a, scelerisque enim.

    Praesent hendrerit consequat nulla, vel convallis diam ornare a. Pellentesque at mauris sit amet metus gravida dapibus. Aenean euismod magna ut lacus placerat vulputate. Aliquam auctor tincidunt elit et consequat. Vivamus tempor mauris justo, vel imperdiet ligula maximus et. Morbi a nunc vitae ligula vulputate finibus a a metus. Fusce eu tellus ligula.

    Nunc aliquam in odio sed auctor. Cras vitae justo tincidunt, vestibulum nibh quis, vestibulum nisl. Fusce tristique facilisis sapien, ut vulputate elit pharetra vitae. Ut id eros sed lectus luctus tincidunt. Nulla et dui pharetra, rutrum est vel, dapibus lorem. Donec purus mauris, condimentum at feugiat et, volutpat at nunc. Etiam ultrices odio neque, sed ullamcorper justo posuere quis. Sed auctor at ex ut commodo. Phasellus non metus fringilla, sodales tortor aliquet, condimentum sem.

    Praesent eget scelerisque tortor. Sed sed condimentum ligula. Quisque id faucibus ipsum. Phasellus neque velit, accumsan nec pulvinar eget, tincidunt sit amet eros. Duis auctor eu sapien eu laoreet. Mauris malesuada blandit mauris, quis ultrices erat facilisis et. Aliquam vel libero ultrices tortor ullamcorper molestie. In rhoncus eu eros eu dictum. Praesent ac mauris pellentesque ante eleifend ultricies id non ligula. Nullam maximus nibh sit amet aliquam euismod. Etiam faucibus ante mollis est sagittis laoreet.
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam eu venenatis erat. Quisque faucibus congue vulputate. In at lorem lacus. Nulla non vestibulum urna. Fusce auctor nisl id pulvinar posuere. Curabitur vel est molestie, eleifend est sed, interdum tellus. Praesent pharetra tortor ultricies orci rutrum ultrices. Nunc porttitor dapibus ullamcorper. Cras eu tortor pulvinar, pretium est nec, faucibus felis. Morbi laoreet, lectus vel maximus euismod, nisl sem placerat neque, congue congue est urna id felis. Morbi vehicula pretium sem eu venenatis. Nullam dapibus leo turpis. Vivamus sit amet ullamcorper ex, ac ultrices arcu. Suspendisse fermentum pretium nisi sit amet fringilla.

    Mauris non sollicitudin quam. Vivamus interdum erat felis, vitae porttitor metus posuere in. Nam laoreet a urna nec suscipit. Integer a eleifend risus. Donec posuere risus at molestie suscipit. Donec varius metus nec nibh egestas, vel bibendum mi ultrices. Praesent volutpat arcu ac tristique pellentesque. Mauris eget turpis venenatis, eleifend justo sit amet, consectetur justo. Duis ut neque a velit aliquet faucibus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec sit amet feugiat lorem. In aliquam eleifend tortor, at cursus dui facilisis nec. Phasellus sed est auctor, ultrices nisl a, scelerisque enim.

    Praesent hendrerit consequat nulla, vel convallis diam ornare a. Pellentesque at mauris sit amet metus gravida dapibus. Aenean euismod magna ut lacus placerat vulputate. Aliquam auctor tincidunt elit et consequat. Vivamus tempor mauris justo, vel imperdiet ligula maximus et. Morbi a nunc vitae ligula vulputate finibus a a metus. Fusce eu tellus ligula.

    Nunc aliquam in odio sed auctor. Cras vitae justo tincidunt, vestibulum nibh quis, vestibulum nisl. Fusce tristique facilisis sapien, ut vulputate elit pharetra vitae. Ut id eros sed lectus luctus tincidunt. Nulla et dui pharetra, rutrum est vel, dapibus lorem. Donec purus mauris, condimentum at feugiat et, volutpat at nunc. Etiam ultrices odio neque, sed ullamcorper justo posuere quis. Sed auctor at ex ut commodo. Phasellus non metus fringilla, sodales tortor aliquet, condimentum sem.

    Praesent eget scelerisque tortor. Sed sed condimentum ligula. Quisque id faucibus ipsum. Phasellus neque velit, accumsan nec pulvinar eget, tincidunt sit amet eros. Duis auctor eu sapien eu laoreet. Mauris malesuada blandit mauris, quis ultrices erat facilisis et. Aliquam vel libero ultrices tortor ullamcorper molestie. In rhoncus eu eros eu dictum. Praesent ac mauris pellentesque ante eleifend ultricies id non ligula. Nullam maximus nibh sit amet aliquam euismod. Etiam faucibus ante mollis est sagittis laoreet.
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam eu venenatis erat. Quisque faucibus congue vulputate. In at lorem lacus. Nulla non vestibulum urna. Fusce auctor nisl id pulvinar posuere. Curabitur vel est molestie, eleifend est sed, interdum tellus. Praesent pharetra tortor ultricies orci rutrum ultrices. Nunc porttitor dapibus ullamcorper. Cras eu tortor pulvinar, pretium est nec, faucibus felis. Morbi laoreet, lectus vel maximus euismod, nisl sem placerat neque, congue congue est urna id felis. Morbi vehicula pretium sem eu venenatis. Nullam dapibus leo turpis. Vivamus sit amet ullamcorper ex, ac ultrices arcu. Suspendisse fermentum pretium nisi sit amet fringilla.

    Mauris non sollicitudin quam. Vivamus interdum erat felis, vitae porttitor metus posuere in. Nam laoreet a urna nec suscipit. Integer a eleifend risus. Donec posuere risus at molestie suscipit. Donec varius metus nec nibh egestas, vel bibendum mi ultrices. Praesent volutpat arcu ac tristique pellentesque. Mauris eget turpis venenatis, eleifend justo sit amet, consectetur justo. Duis ut neque a velit aliquet faucibus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec sit amet feugiat lorem. In aliquam eleifend tortor, at cursus dui facilisis nec. Phasellus sed est auctor, ultrices nisl a, scelerisque enim.

    Praesent hendrerit consequat nulla, vel convallis diam ornare a. Pellentesque at mauris sit amet metus gravida dapibus. Aenean euismod magna ut lacus placerat vulputate. Aliquam auctor tincidunt elit et consequat. Vivamus tempor mauris justo, vel imperdiet ligula maximus et. Morbi a nunc vitae ligula vulputate finibus a a metus. Fusce eu tellus ligula.

    Nunc aliquam in odio sed auctor. Cras vitae justo tincidunt, vestibulum nibh quis, vestibulum nisl. Fusce tristique facilisis sapien, ut vulputate elit pharetra vitae. Ut id eros sed lectus luctus tincidunt. Nulla et dui pharetra, rutrum est vel, dapibus lorem. Donec purus mauris, condimentum at feugiat et, volutpat at nunc. Etiam ultrices odio neque, sed ullamcorper justo posuere quis. Sed auctor at ex ut commodo. Phasellus non metus fringilla, sodales tortor aliquet, condimentum sem.

    Praesent eget scelerisque tortor. Sed sed condimentum ligula. Quisque id faucibus ipsum. Phasellus neque velit, accumsan nec pulvinar eget, tincidunt sit amet eros. Duis auctor eu sapien eu laoreet. Mauris malesuada blandit mauris, quis ultrices erat facilisis et. Aliquam vel libero ultrices tortor ullamcorper molestie. In rhoncus eu eros eu dictum. Praesent ac mauris pellentesque ante eleifend ultricies id non ligula. Nullam maximus nibh sit amet aliquam euismod. Etiam faucibus ante mollis est sagittis laoreet.
</div>
<a href="javascript:scroll(0,0)">Back to top</a>
<%- include footer %>


